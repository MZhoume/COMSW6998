"use strict";function getKeys(e){return"customers"===e?customerKeys:"addresses"===e?addressKeys:void 0}function validate(e,a,t){return!(!e||!Validator[a](e))||(t(new Error("Value: "+e+" is not validated as "+a)),!1)}function tryFind(e,a){return e.item&&e.item[a]?e.item[a]:e.values&&e.values[a]?e.values[a]:void 0}function handler(e,a,t){var r=new sdk.DynamoDB.DocumentClient,i=new DBManager(r),n=e.tableName,s=tryFind(e.payload,"email");if(!s||validate(s,"email",t)){var d=tryFind(e.payload,"zipcode");if(!d||validate(d,"zipcode",t))switch(e.operation){case"create":var o={},u=e.payload.item;getKeys(n).forEach(function(e){o[e]=u[e]}),i.create(n,o,t);break;case"read":i.read(n,e.payload,t);break;case"update":i.update(n,e.payload,t);break;case"delete":i.delete(n,e.payload,t);break;case"find":i.find(n,e.payload,t);break;case"getaddr":i.read("customers",e.payload,function(e,a){if(a){var r=a.Item.address_ref;i.read("addresses",{key:{uuid:r}},t)}})}}}var sdk=require("aws-sdk"),customerKeys=["email","firstname","lastname","phonenumber","address_ref"],addressKeys=["uuid","city","street","num","zipcode"],DBManager=function(){function e(e){this._db=e}return e.prototype.create=function(e,a,t){var r={TableName:e,Item:a};this._db.put(r,t)},e.prototype.read=function(e,a,t){var r={TableName:e,Key:a.key};this._db.get(r,t)},e.prototype.update=function(e,a,t){var r=this;this._db.get({TableName:e,Key:a.key},function(i,n){if(!n)return void t(new Error("Email: "+a.key.email+" does not exists."));var s=n.Item,d={};getKeys(e).forEach(function(e){a.values[e]&&s[e]!==a.values[e]&&(d[e]={Action:"PUT",Value:a.values[e]})});var o={TableName:e,Key:a.key,AttributeUpdates:d};r._db.update(o,t)})},e.prototype.delete=function(e,a,t){var r={TableName:e,Key:a.key};this._db.delete(r,t)},e.prototype.find=function(e,a,t){var r={TableName:e,FilterExpression:a.expression,ExpressionAttributeValues:a.values};this._db.scan(r,t)},e}(),Validator={email:function(e){var a=/^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.(aero|arpa|biz|com|coop|edu|gov|info|int|mil|museum|name|net|org|pro|travel|mobi|[a-z][a-z])|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i;return a.test(e)},zipcode:function(e){var a=/^\d{5}$/;return a.test(e)}};exports.handler=handler;