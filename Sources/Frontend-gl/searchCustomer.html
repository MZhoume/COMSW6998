<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Search customer | Typer's Project</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <meta name="description" content="The project of Typer" />

        <link rel="stylesheet" type="text/css" href="./semantic/dist/semantic.min.css">
        <script src="./semantic/dist/semantic.min.js"></script>
		<script src="./jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
		<link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
      <div class="ui secondary pointing menu">
      	<div class="header item">Typer's Project</div>
		  <div class="right menu">
			  <a class="active item" href="#">Home</a>
		  </div>
	  </div>

	  <div class="main ui container">
			<div class="ui grid" style="margin-top: 50px">
				<div class="row">
					<div class="ten wide centered column">
						<!--<form class="ui form" onsubmit="search()">-->
						<div class="ui form">
							<div class="field ui icon input" style="width: 100%">
								<input type="text" name="email" id="email" placeholder="Customer Email">
								<i class="search link icon" id="search"></i>
							</div>
						</div>
					</div>
				</div>
				<div class="row update-table">
					<div class="ten wide centered column">
						<div class="ui attached message">
							<div class="header">Update customer profile</div>
						</div>
						<div class="ui form attached segment">
							<div class="field">
								<label>Name</label>
								<div class="two fields">
									<div class="field"><input type="text" name="firstname" placeholder="First Name"></div>
									<div class="field"><input type="text" name="lastname" placeholder="Last Name"></div>
								</div>
								<div class="two fields">
									<div class="field">
										<input type="text" name="email" placeholder="Email" disabled>
									</div>
									<div class="field"><input type="text" name="phonenumber" placeholder="Phone Number"></div>
								</div>
							</div>
							<div class="field">
								<label>Address</label>
								<div class="fields">
									<div class="four wide field">
										<input type="text" name="num" id="street_number" placeholder="No.">
									</div>
									<div class="twelve wide field">
										<input type="text" name="street" id="route" placeholder="Street">
									</div>
								</div>
								<div class="three fields">
									<div class="field">
										<input type="text" name="apt" id="street_number" placeholder="Apt/Suite">
									</div>
									<div class="field">
										<input type="text" name="city" id="locality" placeholder="City">
									</div>
									<div class="field">
										<input type="text" name="zipcode" id="postal_code" placeholder="Zipcode"/>
									</div>
								</div>
							</div>
							<button class="ui primary button" id="update-submit">Update</button>
						</div>
						<div class="ui bottom attached negative message" style="display: none">
							<i class="icon remove"></i>
							<span id="error-msg"></span>
						</div>
						<div class="ui bottom attached success message" style="display: none">
							<i class="icon hand peace"></i>
							Profile successfully updated!</a>.
						</div>
					</div>
				</div>

				<div class="row result-table" style="display: none;">
					<div class="thirteen wide centered column">
						<table class="ui blue table">
							<thead>
								<tr>
									<th>Fisrname</th>
									<th>Lastname</th>
									<th>Email</th>
									<th>Phone Number</th>
									<th>Operation</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
									<td></td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<div class="row noresult" style="display: none;">
					<div class="ten wide centered column">
						<div class="ui fluid negative message">
							<i class="icon frown"></i>Oops! No result found.
						</div>
					</div>
				</div>

	  </div>
	</div>

	<div class="ui text menu">
		<div class="item copyright">Copyright &copy; 2016 Typer. All rights reserved.</div>
	</div>

	<script>
		$(document).ready(function(){
			$("#search").click(function() {
				var emailVal = $("#email").val();
				var customerUrl = "https://vq6yw7je2i.execute-api.us-east-1.amazonaws.com/project2/customers/" + emailVal;
				var addressUrl = "https://vq6yw7je2i.execute-api.us-east-1.amazonaws.com/hw1_new/addresses/";
				$.getJSON(customerUrl, function(data) {
					if(data.item) {
						$(".result-table table tbody tr td:first-child").html(data.item["firstname"]);
						$(".result-table table tbody tr td:nth-child(2)").html(data.item["lastname"]);
						$(".result-table table tbody tr td:nth-child(3)").html(data.item["email"]);
						$(".result-table table tbody tr td:nth-child(4)").html(data.item["phonenumber"]);
						$(".result-table table tbody tr td:last-child").html("");
						$(".result-table table tbody tr td:last-child").append('<button class="ui yellow basic button update-btn">Update</button>');
						$(".result-table table tbody tr td:last-child").append('<a href="' + customerUrl + '"><button class="ui red basic button">Delete</button></a>');

						$("input[name='firstname']").val(data.item["firstname"]);
						$("input[name='lastname']").val(data.item["lastname"]);
						$("input[name='email']").val(data.item["email"]);
						$("input[name='phonenumber']").val(data.item["phonenumber"]);
						addressUrl = addressUrl  + data.item["Delivery_Point_Barcode"];
						
						//$(".update-table").hide();
						$(".noresult").hide();
						$(".result-table").show();
					}
					else {
						$(".update-table").hide();
						$(".result-table").hide();
						$(".noresult").show();
					}
				});
				
				$.getJSON(addressUrl, function(data) {
					if(data.item) {
						$("input[name='street']").val(data.item["street"]);
						$("input[name='apt']").val(data.item["num"]);
						$("input[name='city']").val(data.item["city"]);
						$("input[name='zipcode']").val(data.item["zipcode"]);
					}
				});
			});

			$(".update-btn").click(function(){
				$(".result-table").hide();
				$(".noresult").hide();
				$(".update-table").show();
			});


			$("input[name='email']").blur(function(){
				checkEmail($(this).val());
			});
			$("input[name='phonenumber']").blur(function(){
				checkPhonenumber($(this).val());
			});

			$("#update-submit").click(function() {
				var customerUrl = "https://oqw8vpic39.execute-api.us-east-1.amazonaws.com/v1/demo/customers";
				//var addrUrl = "https://oqw8vpic39.execute-api.us-east-1.amazonaws.com/v1/demo/customers";
				var firstnameVal = $("input[name='firstname']").val();
				var lastnameVal = $("input[name='lastname']").val();
				var emailVal = $("input[name='email']").val();
				var phonenumberVal = $("input[name='phonenumber']").val();
				var numVal = $("input[name='street_number']").val();
				var streetVal = $("input[name='route']").val();
				var cityVal = $("input[name='city']").val();
				var stateVal = $("input[name='state']").val();
				var zipcodeVal = $("input[name='zipcode']").val();
				var countryVal = $("input[name='country']").val();
				//var addressVal = numVal + streetVal + cityVal + stateVal + zipcodeVal + countryVall;
				console.log('before nul check');
				if(!checkNull(firstnameVal, lastnameVal, emailVal, phonenumberVal, numVal, streetVal, cityVal, stateVal, zipcodeVal, countryVal)) return;
				console.log('before email check');
				console.log('before tel ck');
				if(!checkPhonenumber(phonenumberVal)) return;
				//if(!checkAddress(aVal)) return;

				/*
				{
					"operation": "create",
					"tableName": "customers",
					"payload": {
						"item": {"fistname":"emily","lastname":"hua","phonenumber":"3472782514","email":"huaye1992@gmail.com"}
					}
				}
				*/
				console.log('before post');
				$.ajax({
					type : 'POST',
					url : customerUrl,
					crossDomain : true,
					data : {
						operation : "create",
						tableName : "customers",
						payload : {
							item : {
								email : emailVal,
								firstname : firstnameVal,
								lastname : lastnameVal,
								phonenumber : phonenumberVal
								/*, address_ref : addressVal*/
							}
						}
					},
					dataType: 'jsonp',
					headers: {
						"Access-Control-Allow-Origin" : "*"
					},
					success: function() {
						$(".negative.message").hide();
						$(".success.message").show();
					},
					error: function() {
						$(".success.message").hide();
						$("#error-msg").html('Failed to create new customer, please try again later.');
						$(".negative.message").show();
					}
				});
			});

			function checkNull(firstnameVal, lastnameVal, emailVal, phonenumberVal, numVal, streetVal, cityVal, stateVal, zipcodeVal, countryVal) {
				if(firstnameVal == "" || lastnameVal == "" ||
					emailVal == "" || phonenumberVal == "" ||
					numVal == "" || streetVal == "" ||
					cityVal == "" || stateVal == "" ||
					zipcodeVal == "" || countryVal == "") {
					$('#error-msg').html('All fields are required.');
					$('.negative.message').show();
					$('.success.message').hide();
					return false;
				}
				return true;
			};

			function checkPhonenumber(phonenumber) {
				$(".negative.message").hide();
				var regex = /^\d{10}$/;
				if(regex.test(phonenumber)) return true;
				else {
					$(".success.message").hide();
					$("#error-msg").html('Invalid phone number.');
					$(".negative.message").show();
					return false;
				}
			};

			function checkAddress(address) {

			};
		});
	</script>
	</body>
</html>